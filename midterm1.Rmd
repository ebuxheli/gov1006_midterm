---
title: "Midterm 1"
author: "Enxhi Buxheli"
date: "3/7/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

# Attaching necessary libraries
# WARNING: when trying to use select, needed to specify dplyr::select
#   After eliminating some libraries as they were not necessary, this
#   may not be necessary anymore. Need to check.
library(tidyverse)
library(dplyr)
library(mediation)
library(haven)
library(ggplot2)
library(rstanarm)
library(tibble)

# Looking at the dataverse_files for the replication, anxiety.csv looks like
# it's use provided information while mTurk (assuming from Amazon Mechanical
# Turk) is the test output from the experiment [MAYBE]
```

```{r cleanup}
# age: age of the test subject
# storycond: indicator for which randomly assigned 1 of 2 stories for subject (Jose/Niko)
# relaxvid: indicator for whether or not subject saw relaxing video "Crystal Chakra"
# anxcond = anxietyvid: indicator for if subject saw anxiety video "Cliffhanger".
#       This is also a binary on whether the person was given a stressful
#       scenario or not (neutral)
# anxcond3: indicator whether under relaxed (0), neutral (1), or anxiety (2) conditions 
# emo: emotion on which they gave the self-reported immigration rating
# immigration: response to 5-point scale on immigration statements (pg. 6)
# ideology: political preference with 1 - Liberal, 7 - Conservative
# CellId: 1-3 (Niko, Relax Neutral Anxiety), 4-6 (Jose, Relax Neutral Anxiety)
# SCDBradVidManipAll_mean: mean skin conductivity
#
# anything with a vid suffix means that video stimulus was used 
#   [verifies that other emotions weren't inadvertently triggered]

# Reading in the STATA data file using a function from the haven library
# Looks like the numbers for age from STATA were forced to be integers (%8.0g)
data <- read_dta("dataverse_files/replicationdata.dta")

# Getting rid of the format attribute that says the data is from stata 
# This isn't necessary, but when looking at the data it won't show format
# anymore which is nice when handling. Here I tried to recode the data to 
# make it easier to read, but ran into troubles when trying to group it.
# The data showed up fine, but the grouping failed...
data <- zap_formats(data) 

# The mean and sd for age check out!
# This output is not included in the output because it is not
# necessary for the replication. Just a sanity check.
# mean(data$age, na.rm = TRUE)
# sd(data$age, na.rm = TRUE)
```


```{r figure2, results='asis'}
# Function to calculate the 95% confidence interval for Skin Conductivity based
# on the video treatment. This returns the lower and upper limit of the
# confidence interval for the linear model specificied in the paper.
anxiety_confint <- function(anxiety) {
  # Calculating confidence interval
  temp_dat <- filter(data, anxcond3 == anxiety)
  anx_SCDVid <- lm(SCDBradVidManipAll_mean ~ anxcond3, data = temp_dat)
  conf <- tibble(confint.lm(anx_SCDVid)[1,1:2])

  # Outputting the confidence interval
  conf
}

# Here are the confidence intervals properly formatted for output. These
# intervals were created using the anxiety_confint function above. Column
# names are changed for readability

# Relaxed with formatting
relax_conf   <- anxiety_confint("0") %>%
  mutate(treatment = "relax")
rownames(relax_conf) <- c("lower", "upper")
relax_conf <- rownames_to_column(relax_conf)
colnames(relax_conf) <- c("type", "interval", "treatment")
# Subsetting the data
low_relax <- filter(relax_conf, type == "lower")
up_relax  <- filter(relax_conf, type == "upper")

# Neutral with formatting
neutral_conf <- tibble(anxiety_confint("1")) %>%
  mutate(treatment = "neutral")
rownames(neutral_conf) <- c("lower", "upper")
neutral_conf <- rownames_to_column(neutral_conf)
colnames(neutral_conf) <- c("type", "interval", "treatment")
# Subsetting the data
low_neu <- filter(neutral_conf, type == "lower")
up_neu  <- filter(neutral_conf, type == "upper")

# Anxiety with formatting
anxiety_conf <- tibble(anxiety_confint("2")) %>%
  mutate(treatment = "anxiety")
rownames(anxiety_conf) <- c("lower", "upper")
anxiety_conf <- rownames_to_column(anxiety_conf)
colnames(anxiety_conf) <- c("type", "interval", "treatment")
# Subsetting the data
low_anx <- filter(anxiety_conf, type == "lower")
up_anx  <- filter(anxiety_conf, type == "upper")


# Creates a tibble of the lower and upper confidence intervals.
# The reason that it looks like such a mess is that the code didn't seem to run
# properly. For the first "relaxed" dataset, it gave the correct and expected
# output while for the rest it messed it up which caused me much anxiety and a
# lot of time was spent trying to resolve this but to no avail.
# Lower
lower_conf <- t(tibble(Relax = low_relax$interval,
                       Neutral = low_neu$interval$`confint.lm(anx_SCDVid)[1, 1:2]`,
                       Anxiety = low_anx$interval$`confint.lm(anx_SCDVid)[1, 1:2]`))
colnames(lower_conf) <- "lower"

# Upper
upper_conf <- t(tibble(Relax = up_relax$interval,
                       Neutral = up_neu$interval$`confint.lm(anx_SCDVid)[1, 1:2]`,
                       Anxiety = up_anx$interval$`confint.lm(anx_SCDVid)[1, 1:2]`))
colnames(upper_conf) <- "upper"

# Combining the data to be plotted
confidence <- cbind(lower_conf, upper_conf) 
means <- data %>% 
  filter(!is.na(anxcond3), !is.na(SCDBradVidManipAll_mean)) %>% 
  group_by(anxcond3) %>%
  summarise(mean = mean(SCDBradVidManipAll_mean)) %>% 
  arrange(anxcond3) 
         
# Binding the means and confidence to be plotted.
# This was a Eureka moment for me and made my code go from being defunct
# to being operational.
f2 <- cbind(means, confidence) %>% 
  rownames_to_column() 

f2 %>% 
  ggplot() +
    geom_point(aes(x = rowname, y = mean)) + 
    geom_errorbar(aes(x = rowname, ymin = lower, ymax = upper,
                      color = "red"),
                      position = "dodge", width = 0.15, fatten = 2,
                  show.legend = FALSE) +
    scale_y_continuous(limits = c(-0.5, 1.5)) +
      labs(x = "Video Condition",
           y = "Skin Conductance Reactivity") +
    theme_light()


### Data used for figure 2
## Skin conductivity during video
# Simple check for the data. 
# Relaxed mean
r_mean <- filter(data, anxcond3 == "0") %>%
  summarise(mean = mean(SCDBradVidManipAll_mean, na.rm = TRUE))
# Neutral mean
n_mean <- filter(data, anxcond3 == "1") %>%
  summarise(mean = mean(SCDBradVidManipAll_mean, na.rm = TRUE))
# Anxiety mean
a_mean <- filter(data, anxcond3 == "2") %>%
  summarise(mean = mean(SCDBradVidManipAll_mean, na.rm = TRUE))
```
Figure 2: Means of skin-conductance reactivity by video condition. 95% confidence intervals are in red


```{r table1}
# Table 1 displays two linear regression models that comprise the two stages of
# a causal mediation model.
## STATA code
# * (1)
# reg SCDBradSelfReport1_mean anxcond if anxcond3 ~=0
# 
# * (2) 
# reg immigration storycond anxcond SCDBradSelfReport1_mean if anxcond3 ~=0
anx_data <- data %>% 
  filter(anxcond3 != 0) %>% 
  mutate(anxcond3 = anxcond3 - 1)


t1_anxiety <- stan_glm(data = anx_data, SCDBradSelfReport1_mean ~ anxcond)
t1_imm     <- stan_glm(data = anx_data, immigration ~ SCDBradSelfReport1_mean + storycond) 
```



# Not necessary at the moment
*Label variables so tables look nice
label var SCDBradVidManipAll_mean "SCD (Mean) During Video"
label var SCDBradSelfReport1_mean "SCD (Mean) While Answering Questions"
label var emo "Self-Reported Immigration Beliefs"
label var CellID "Brader Condition (6 cells)"
label var anxcond "Anxiety Manipulation Dummy"
label var storycond "Story Condition"
label var interaction "Story X Anxiety"
label variable age "Age"
label variable race "Race"
label variable income "Income"
label variable education "Education"
label variable ideology "Ideology"
label variable anxietyvid "Anxiety Manipulation"
label variable relaxvid "Relax Manipulation"
label variable anxcond3 "Anxiety Condition"
label variable immigration "Immigration DV"





*Figure 2 
* Means of Skin Conductance Reactivity by Video Condition
ciplot SCDBradVidManipAll_mean,by(anxcond3)


* Table 1 in paper
* (1)
reg SCDBradSelfReport1_mean anxcond if anxcond3 ~=0

* (2) 
reg immigration storycond anxcond SCDBradSelfReport1_mean if anxcond3 ~=0



# Figure 2
Want to obtain a confidence interval. Can do so by running a t.test(), but want
to look into more effective ways.
```{r}

```

# Figure 3
```{r, results='asis'}
# Figure 3
# Causal Mediation Plot

# Loading in the anxiety data to be used in the creation of the Figure 3 plot
anxiety <- read_csv("dataverse_files/anxiety.csv")

## Make Subsets (do this last) [Note from the original code]
# This makes a subset of those that were under the neutral and anxiety
# conditions for the video condition.
# noRelaxCond <- subset(anxiety, anxcond3 > 0)
# 
# # Outcome Model
# y <- stan_glm(immigration ~ anxcond + SCDBradSelfReport1_mean + storycond,
#               model = TRUE,
#               data = noRelaxCond)
# y<-  zelig(
#     immigration ~ anxcond + SCDBradSelfReport1_mean + storycond,
#     model = "ls",
#     data = noRelaxCond
#   )
# summary(y) # summarize results from model

# # Mediator Model
# m <-
#   zelig(SCDBradSelfReport1_mean ~ anxcond + storycond,
#     model = "ls",
#     data = noRelaxCond
#   )
# summary(m) # summarize results from model
# 
# # Mediation Analysis
# m.out <-
#   mediate(
#     m,
#     y,
#     sims = 500,
#     treat = "anxcond",
#     mediator = "SCDBradSelfReport1_mean",
#     dropobs = TRUE,
#     boot = TRUE,
#     conf.level = .90
#   )
# summary(m.out)
# plot(
#   m.out,
#   labels = c(
#     "ACME\n(Physiological \nReactivity)",
#     "Direct Effect \n(Anxiety)",
#     "Total Effect"
#   )
# )
```

